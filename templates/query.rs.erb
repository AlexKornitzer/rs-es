// Query DSL - autogenerated (unless you're reading this in query.rs.erb, which is the source)

use std::collections::BTreeMap;

use rustc_serialize::json::{Json, ToJson};

<%= enums['Query'] %>

macro_rules! with {
    ($funcn:ident, $sn:ident, $t:ident) => {
        pub fn $funcn<'a>(&'a mut self, value: $t) -> &'a mut Self {
            self.$sn = Some(value);
            self
        }
    }
}

macro_rules! optional_add {
    ($map:ident, $sn:expr, $field:expr) => {
        match $sn {
            Some(ref value) => { $map.insert($field.to_string(), value.to_json()); }
            _               => ()
        }
    }
}

// Match queries

<%= simple_value_enum('ZeroTermsQuery', ['none', 'all']) %>

#[derive(Clone)]
pub enum Fuzziness {
    Auto,
    LevenshteinDistance(i64),
    Proportionate(f64)
}

impl ToJson for Fuzziness {
    fn to_json(&self) -> Json {
        use self::Fuzziness::{Auto, LevenshteinDistance, Proportionate};
        match self {
            &Auto                      => "auto".to_json(),
            &LevenshteinDistance(dist) => dist.to_json(),
            &Proportionate(prop)       => prop.to_json()
        }
    }
}

<%= simple_value_enum('MatchType', ['phrase', 'phrase_prefix']) %>

<%= simple_value_enum('MatchQueryType', ['best_fields',
                                         'most_fields',
                                         'cross_fields',
                                         'phrase',
                                         'phrase_prefix']) %>

// Option structs for Query(ies)

pub struct MatchAllQuery;

impl MatchAllQuery {
    pub fn build(self) -> Query {
        MatchAll(self)
    }
}

impl ToJson for MatchAllQuery {
    fn to_json(&self) -> Json {
        Json::Object(BTreeMap::new())
    }
}

<%= structs['MatchQuery'] %>

impl ToJson for MatchQuery {
    fn to_json(&self) -> Json {
        let mut inner = BTreeMap::new();
        inner.insert("query".to_string(), self.query.clone());

        self.add_optionals(&mut inner);

        let mut d = BTreeMap::new();
        d.insert(self.field.clone(), Json::Object(inner));

        Json::Object(d)
    }
}

<%= structs['MultiMatchQuery'] %>

impl ToJson for MultiMatchQuery {
    fn to_json(&self) -> Json {
        let mut d = BTreeMap::new();
        d.insert("query".to_string(), self.query.clone());
        d.insert("fields".to_string(), self.fields.to_json());

        self.add_optionals(&mut d);

        Json::Object(d)
    }
}
